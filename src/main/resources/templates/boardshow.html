<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TimeBank - ê²Œì‹œê¸€ ìƒì„¸</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #5CB85C;
            --primary-dark: #4A934A;
            --primary-light: #A7D7A3;
            --secondary-color: #F6FFF6;
            --text-primary: #3E7C4A;
            --text-secondary: #666;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        body {
            font-family: 'Segoe UI', sans-serif;
            background-color: var(--primary-light);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .navbar {
            background-color: white;
            box-shadow: var(--shadow);
        }

        .main-container {
            flex: 1;
            padding: 2rem;
            display: flex;
            justify-content: center;
            align-items: flex-start;
        }

        .content-card {
            background-color: white;
            border-radius: 15px;
            box-shadow: var(--shadow);
            width: 100%;
            max-width: 900px;
            padding: 2rem;
            margin-top: 1rem;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
            border-radius: 10px;
            padding: 0.5rem 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            background-color: var(--primary-dark);
        }

        .btn-secondary {
            background-color: #f0f0f0;
            color: var(--text-secondary);
            border-radius: 10px;
            padding: 0.5rem 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-secondary:hover {
            background-color: #e0e0e0;
        }

        .btn-danger {
            background-color: #ff6b6b;
            color: white;
        }

        .btn-danger:hover {
            background-color: #ff4c4c;
        }

        .btn-success {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-success:hover {
            background-color: var(--primary-dark);
        }

        .btn-outline {
            border: 1px solid var(--primary-color);
            color: var(--primary-color);
            background-color: transparent;
        }

        .btn-outline:hover {
            background-color: var(--primary-color);
            color: white;
        }

        .label {
            font-weight: 600;
            color: var(--text-primary);
        }

        .participant-box {
            background-color: var(--secondary-color);
            border: 1px solid #E0F0E0;
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 1rem;
            transition: all 0.3s ease;
        }

        .participant-box:hover {
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .content-block {
            margin-bottom: 1.5rem;
        }

        .header-title {
            color: var(--text-primary);
            font-weight: 700;
            font-size: 1.5rem;
        }

        .section-title {
            color: var(--text-primary);
            font-weight: 600;
            font-size: 1.2rem;
            margin-bottom: 1rem;
            margin-top: 2rem;
            display: flex;
            align-items: center;
        }

        .section-title i {
            margin-right: 0.5rem;
        }

        .badge {
            background-color: #E0F0E0;
            color: var(--text-primary);
            font-size: 0.8rem;
            padding: 0.25rem 0.75rem;
            border-radius: 50px;
            display: inline-block;
            margin-bottom: 0.5rem;
        }

        .like-button {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background-color: white;
            border: 1px solid #ff6b6b;
            color: #ff6b6b;
            border-radius: 8px;
            padding: 0.3rem 0.8rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .like-button:hover {
            background-color: #fff0f0;
        }

        .like-button i {
            font-size: 1rem;
        }

        footer {
            background-color: white;
            color: var(--text-secondary);
            text-align: center;
            padding: 1rem;
            margin-top: 2rem;
            box-shadow: 0 -1px 3px rgba(0, 0, 0, 0.1);
        }

        .loading {
            display: flex;
            justify-content: center;
            padding: 2rem;
        }

        .loading::after {
            content: "ë¡œë”© ì¤‘...";
            color: var(--text-primary);
            font-weight: 500;
        }

        .status {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 50px;
            font-weight: 600;
            font-size: 0.8rem;
        }

        .status-open {
            background-color: #e0f7e0;
            color: #2e7d32;
        }

        .status-closed {
            background-color: #f5f5f5;
            color: #757575;
        }

        /* ì• ë‹ˆë©”ì´ì…˜ íš¨ê³¼ */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .fade-in {
            animation: fadeIn 0.3s ease-out forwards;
        }

        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #E0F0E0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: var(--text-primary);
        }

        .card-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        @media (max-width: 640px) {
            .main-container {
                padding: 1rem;
            }

            .content-card {
                padding: 1.5rem;
            }
        }
    </style>
</head>
<body>
<!-- ë„¤ë¹„ê²Œì´ì…˜ ë°” -->
<nav class="navbar py-4 px-6 flex items-center justify-between">
    <div class="flex items-center">
        <a href="/" class="text-2xl font-bold text-green-600 flex items-center">
            <i class="fas fa-clock mr-2"></i>
            <span>TimeBank</span>
        </a>
    </div>
    <div class="flex items-center gap-4">
        <a href="/boardpage" class="btn-outline py-2 px-4 rounded-lg">
            <i class="fas fa-list-ul mr-1"></i> ê²Œì‹œíŒ
        </a>
        <a href="/mypage" class="btn-primary py-2 px-4 rounded-lg">
            <i class="fas fa-user mr-1"></i> ë§ˆì´í˜ì´ì§€
        </a>
    </div>
</nav>

<!-- ë©”ì¸ ì»¨í…ì¸  -->
<div class="main-container">
    <div class="content-card">
        <div id="loading" class="loading"></div>

        <div id="board-detail" class="hidden fade-in">
            <!-- í—¤ë” ì˜ì—­ -->
            <div class="flex justify-between items-start mb-6">
                <h1 class="header-title text-2xl" id="title"></h1>
                <div>
                    <span class="status status-open" id="status-badge">ëª¨ì§‘ì¤‘</span>
                </div>
            </div>

            <!-- ê¸°ë³¸ ì •ë³´ ì˜ì—­ -->
            <div class="content-block">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <span class="badge" id="category-badge"></span>
                        <div class="mt-2">
                            <span class="label">ì‘ì„±ì:</span>
                            <span id="author" class="ml-2"></span>
                        </div>
                        <div class="mt-2">
                            <span class="label">ì‘ì„±ì¼:</span>
                            <span id="created-date" class="ml-2"></span>
                        </div>
                    </div>
                    <div>
                        <div class="flex items-center justify-end gap-2 mb-3">
                            <button class="like-button" onclick="likeBoard()">
                                <i class="fas fa-heart"></i>
                                <span id="like-count">0</span>
                            </button>
                            <span class="bg-green-100 text-green-800 py-1 px-3 rounded-full font-medium">
                  <i class="fas fa-coins mr-1"></i>
                  <span id="credit-price"></span> í¬ë ˆë”§
                </span>
                        </div>
                    </div>
                </div>
            </div>

            <hr class="my-4 border-gray-200">

            <!-- ë‚´ìš© ì˜ì—­ -->
            <div class="content-block">
                <div class="label mb-2">ë‚´ìš©</div>
                <div id="description" class="bg-gray-50 rounded-lg p-4 text-gray-700 min-h-[100px]"></div>
            </div>

            <!-- ë²„íŠ¼ ì˜ì—­ -->
            <div class="flex flex-wrap gap-2 justify-end">
                <button class="btn-secondary" onclick="goBack()">
                    <i class="fas fa-arrow-left mr-1"></i> ëª©ë¡ìœ¼ë¡œ
                </button>
                <button id="apply-button" class="btn-primary" onclick="applyToBoard()">
                    <i class="fas fa-hand-paper mr-1"></i> ì°¸ì—¬ ì‹ ì²­
                </button>
                <button id="edit-button" class="btn-secondary hidden" onclick="editBoard()">
                    <i class="fas fa-edit mr-1"></i> ìˆ˜ì •
                </button>
                <button id="delete-button" class="btn-danger hidden" onclick="deleteBoard()">
                    <i class="fas fa-trash mr-1"></i> ì‚­ì œ
                </button>
            </div>

            <hr class="my-6 border-gray-200">

            <!-- ì°¸ì—¬ì ëª©ë¡ ì˜ì—­ -->
            <div id="participants-section">
                <h2 class="section-title">
                    <i class="fas fa-users"></i> ì°¸ì—¬ ìš”ì²­ì ëª©ë¡
                </h2>
                <div id="participants-list" class="grid grid-cols-1 gap-3"></div>

                <h2 class="section-title mt-6">
                    <i class="fas fa-user-check"></i> ìŠ¹ì¸ëœ ì°¸ì—¬ì ëª©ë¡
                </h2>
                <div id="approved-participants-list" class="grid grid-cols-1 gap-3"></div>
            </div>
        </div>
    </div>
</div>

<footer class="py-4">
    <div class="container mx-auto">
        <p>&copy; 2025 TimeBank - ëª¨ë‘ì˜ ì‹œê°„ì„ ê°€ì¹˜ìˆê²Œ</p>
    </div>
</footer>

<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script>
    const token = localStorage.getItem('accessToken');
    const boardId = location.pathname.split('/').pop();
    let currentUserData = null;
    let boardData = null;

    // ë¡œë”© ìƒíƒœ í‘œì‹œ/ìˆ¨ê¹€ í•¨ìˆ˜
    function toggleLoading(show) {
        const loadingElement = document.getElementById('loading');
        const detailElement = document.getElementById('board-detail');

        if (show) {
            loadingElement.classList.remove('hidden');
            detailElement.classList.add('hidden');
        } else {
            loadingElement.classList.add('hidden');
            detailElement.classList.remove('hidden');
        }
    }

    async function checkAuth() {
        if (!token) {
            alert('ë¡œê·¸ì¸ì´ í•„ìš”í•œ ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤.');
            window.location.href = '/login';
            return false;
        }
        return true;
    }

    async function getCurrentUser() {
        try {
            const res = await axios.get('/api/users/me', {
                headers: { 'Authorization': token }
            });
            currentUserData = res.data;
            return res.data;
        } catch (err) {
            console.error('ì‚¬ìš©ì ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤:', err);
            return null;
        }
    }

    async function loadBoard() {
        toggleLoading(true);
        try {
            const res = await axios.get(`/api/boards/${boardId}`, {
                headers: { Authorization: token }
            });
            boardData = res.data;

            // ê²Œì‹œê¸€ ì •ë³´ í‘œì‹œ
            document.getElementById('title').textContent = boardData.title;
            document.getElementById('description').textContent = boardData.description;
            document.getElementById('category-badge').textContent = convertCategory(boardData.category);
            document.getElementById('credit-price').textContent = boardData.creditPrice;
            document.getElementById('author').textContent = boardData.authorName || 'ì•Œ ìˆ˜ ì—†ìŒ';
            document.getElementById('created-date').textContent = formatDate(boardData.createdAt);
            document.getElementById('like-count').textContent = boardData.likeCount;

            // ìƒíƒœ ë°°ì§€ ì—…ë°ì´íŠ¸
            const statusBadge = document.getElementById('status-badge');
            if (boardData.closed) {
                statusBadge.textContent = 'ëª¨ì§‘ ë§ˆê°';
                statusBadge.classList.remove('status-open');
                statusBadge.classList.add('status-closed');
            } else {
                statusBadge.textContent = 'ëª¨ì§‘ì¤‘';
                statusBadge.classList.remove('status-closed');
                statusBadge.classList.add('status-open');
            }

            // í˜„ì¬ ì‚¬ìš©ìê°€ ê²Œì‹œê¸€ ì‘ì„±ìì¸ì§€ í™•ì¸
            const user = await getCurrentUser();
            if (user && boardData.authorId === user.id) {
                document.getElementById('edit-button').classList.remove('hidden');
                document.getElementById('delete-button').classList.remove('hidden');
                document.getElementById('apply-button').classList.add('hidden');
            }

        } catch (err) {
            console.error(err);
            alert('ê²Œì‹œê¸€ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
        } finally {
            toggleLoading(false);
        }
    }

    async function loadParticipants() {
        try {
            const res = await axios.get(`/api/boards/${boardId}/allregister`, {
                headers: { Authorization: token }
            });
            const container = document.getElementById('participants-list');
            container.innerHTML = '';

            // ë¡œê·¸ì¸í•œ ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸°
            const user = currentUserData || await getCurrentUser();
            const isAuthor = user && boardData && boardData.authorId === user.id;

            // ìš”ì²­ ëŒ€ê¸° ì¤‘ì¸ ì°¸ê°€ìë§Œ í•„í„°ë§
            const pendingParticipants = res.data.filter(p => {
                if (typeof p.status === 'string') return p.status === 'PENDING';
                if (typeof p.status === 'object' && p.status.name) return p.status.name === 'PENDING';
                return false;
            });

            if (pendingParticipants.length === 0) {
                container.innerHTML = '<p class="text-gray-500 italic">ìš”ì²­ ëŒ€ê¸° ì¤‘ì¸ ì°¸ê°€ìê°€ ì—†ìŠµë‹ˆë‹¤</p>';
                return;
            }

            pendingParticipants.forEach(p => {
                    const div = document.createElement('div');
                    div.className = 'participant-box flex justify-between items-center flex-wrap';

                    const userInfo = document.createElement('div');
                userInfo.className = 'flex items-center gap-3';

                const avatar = document.createElement('div');
                avatar.className = 'avatar';

                // userIdê°€ ìˆ«ìë¼ë„ ë¬¸ìì—´ë¡œ ë³€í™˜í•´ì„œ ì‚¬ìš©
                avatar.textContent = String(p.userId).substring(0, 1).toUpperCase();

                userInfo.appendChild(avatar);
                userInfo.innerHTML += `<p class="font-medium">${p.userId}</p>`;

                div.appendChild(userInfo);

                // ì‘ì„±ìì¸ ê²½ìš°ì—ë§Œ ìŠ¹ì¸/ê±°ì ˆ ë²„íŠ¼ í‘œì‹œ
                if (isAuthor) {
                    const actions = document.createElement('div');
                    actions.className = 'card-actions';
                    actions.innerHTML = `
                  <button class="btn-success px-3 py-1 rounded-lg text-sm" onclick="approve(${p.id})">
                    <i class="fas fa-check mr-1"></i> ìŠ¹ì¸
                  </button>
                  <button class="btn-danger px-3 py-1 rounded-lg text-sm" onclick="reject(${p.id})">
                    <i class="fas fa-times mr-1"></i> ê±°ì ˆ
                  </button>
                `;
                    div.appendChild(actions);
                }

                container.appendChild(div);
            });
        } catch (err) {
            console.error(err);
            document.getElementById('participants-list').innerHTML =
                '<p class="text-red-500">ì°¸ì—¬ì ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</p>';
        }
    }

    async function loadApprovedParticipants() {
        try {
            const res = await axios.get(`/api/boards/${boardId}/approved-participants`, {
                headers: { Authorization: token }
            });

            const container = document.getElementById('approved-participants-list');
            container.innerHTML = '';

            if (res.data.length === 0) {
                container.innerHTML = '<p class="text-gray-500 italic">ìŠ¹ì¸ëœ ì°¸ê°€ìê°€ ì—†ìŠµë‹ˆë‹¤</p>';
                return;
            }

            // ë¡œê·¸ì¸í•œ ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸°
            const user = currentUserData || await getCurrentUser();
            const isAuthor = user && boardData && boardData.authorId === user.id;

            res.data.forEach(p => {
                const div = document.createElement('div');
                div.className = 'participant-box flex justify-between items-center flex-wrap';

                const userInfo = document.createElement('div');
                userInfo.className = 'flex items-center gap-3';

                const avatar = document.createElement('div');
                avatar.className = 'avatar';
                avatar.textContent = p.username?.charAt(0).toUpperCase() || '?';

                const nameText = document.createElement('p');
                nameText.className = 'font-medium';
                nameText.textContent = p.username || 'ì•Œ ìˆ˜ ì—†ìŒ';

                userInfo.appendChild(avatar);
                userInfo.appendChild(nameText);
                div.appendChild(userInfo);

                // ì‘ì„±ìì¸ ê²½ìš°ì—ë§Œ í™˜ë¶ˆ ë²„íŠ¼ í‘œì‹œ
                if (isAuthor) {
                    const actions = document.createElement('div');
                    actions.className = 'card-actions';
                    actions.innerHTML = `
                    <button class="bg-yellow-500 hover:bg-yellow-600 text-white px-3 py-1 rounded-lg text-sm" onclick="refund(${p.id})">
                        <i class="fas fa-undo mr-1"></i> í™˜ë¶ˆ
                    </button>
                `;
                    div.appendChild(actions);
                }

                container.appendChild(div);
            });
        } catch (err) {
            console.error(err);
            document.getElementById('approved-participants-list').innerHTML =
                '<p class="text-red-500">ìŠ¹ì¸ëœ ì°¸ì—¬ì ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</p>';
        }
    }

    async function approve(participationId) {
        if (!await checkAuth()) return;

        try {
            await axios.put(`/api/boards/${participationId}/approve`, null, {
                headers: { Authorization: token }
            });
            alert('âœ… ì°¸ì—¬ê°€ ìŠ¹ì¸ë˜ì—ˆìŠµë‹ˆë‹¤!');
            loadParticipants();
            loadApprovedParticipants();
        } catch (err) {
            console.error(err);
            alert('âš ï¸ ì°¸ì—¬ ìŠ¹ì¸ ì‹¤íŒ¨');
        }
    }

    async function reject(participationId) {
        if (!await checkAuth()) return;

        try {
            await axios.put(`/api/boards/${participationId}/reject`, null, {
                headers: { Authorization: token }
            });
            alert('ğŸš« ì°¸ì—¬ê°€ ê±°ì ˆë˜ì—ˆìŠµë‹ˆë‹¤.');
            loadParticipants();
        } catch (err) {
            console.error(err);
            alert('âš ï¸ ì°¸ì—¬ ê±°ì ˆ ì‹¤íŒ¨');
        }
    }

    async function refund(participationId) {
        if (!await checkAuth()) return;

        try {
            await axios.put(`/api/board-participation/${participationId}/refund`, null, {
                headers: { Authorization: token }
            });
            alert('ğŸ’° í™˜ë¶ˆ ìš”ì²­ ì™„ë£Œ!');
            loadApprovedParticipants();
        } catch (err) {
            console.error(err);
            alert('âš ï¸ í™˜ë¶ˆ ìš”ì²­ ì‹¤íŒ¨');
        }
    }

    async function likeBoard() {
        if (!await checkAuth()) return;

        try {
            await axios.post(`/api/boards/${boardId}/like`, null, {
                headers: { Authorization: token }
            });
            const countElement = document.getElementById('like-count');
            countElement.textContent = parseInt(countElement.textContent) + 1;

            // ì¢‹ì•„ìš” ë²„íŠ¼ì— ì• ë‹ˆë©”ì´ì…˜ íš¨ê³¼ ì¶”ê°€
            const likeButton = document.querySelector('.like-button');
            likeButton.classList.add('bg-red-50');
            setTimeout(() => {
                likeButton.classList.remove('bg-red-50');
            }, 300);
        } catch (err) {
            console.error(err);
            alert('ì¢‹ì•„ìš” ì‹¤íŒ¨');
        }
    }

    async function applyToBoard() {
        if (!await checkAuth()) return;

        if (confirm('ì´ ê²Œì‹œê¸€ì— ì°¸ì—¬ ì‹ ì²­í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            try {
                await axios.post(`/api/board-participation/request?boardId=${boardId}`, null, {
                    headers: { 'Authorization': token }
                });
                alert('ğŸ‰ ì°¸ì—¬ ì‹ ì²­ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!');
            } catch (err) {
                console.error(err);
                alert('ì°¸ì—¬ ì‹ ì²­ ì‹¤íŒ¨');
            }
        }
    }

    async function deleteBoard() {
        if (!await checkAuth()) return;

        if (confirm('ì •ë§ ì´ ê²Œì‹œê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            try {
                await axios.delete(`/api/boards/${boardId}`, {
                    headers: { 'Authorization': token }
                });
                alert('ğŸ“Œ ê²Œì‹œê¸€ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤!');
                window.location.href = '/boardpage';
            } catch (error) {
                console.error(error);
                alert('âš ï¸ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤. ì‘ì„±ìë§Œ ê²Œì‹œê¸€ì„ ì‚­ì œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
            }
        }
    }

    function editBoard() {
        window.location.href = `/board/modify/${boardId}`;
    }

    function goBack() {
        window.location.href = '/boardpage';
    }

    function convertCategory(category) {
        const dict = {
            EDUCATION: "êµìœ¡ & í•™ìŠµ",
            IT: "IT & ê°œë°œ",
            DESIGN: "ë””ìì¸ & ì˜ˆìˆ ",
            TRANSLATION: "ë²ˆì—­ & ì‘ë¬¸",
            LIFESTYLE: "ìƒí™œ & ì·¨ë¯¸",
            ENGINEERING: "ê³µí•™ & ê³¼í•™",
            BUSINESS: "ë¹„ì¦ˆë‹ˆìŠ¤ & ê¸ˆìœµ",
            VOLUNTEERING: "ì‚¬íšŒë´‰ì‚¬ & ê³µìµ",
            HEALTHCARE: "ê±´ê°• & ì˜ë£Œ",
            SPORTS: "ìŠ¤í¬ì¸  & íŠ¸ë ˆì´ë‹",
            COOKING: "ìš”ë¦¬ & ë² ì´í‚¹",
            ETC: "ê¸°íƒ€ ë§ì¶¤í˜• ì¬ëŠ¥",
            TECHNOLOGY: "ê¸°ìˆ "
        };
        return dict[category] || category;
    }

    function formatDate(dateString) {
        if (!dateString) return 'N/A';

        const date = new Date(dateString);
        return date.toLocaleDateString('ko-KR', {
            year: 'numeric',
            month: 'long',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
    }

    document.addEventListener('DOMContentLoaded', async () => {
        if (!await checkAuth()) return;

        loadBoard();
        loadParticipants();
        loadApprovedParticipants();
    });
</script>
</body>
</html>
